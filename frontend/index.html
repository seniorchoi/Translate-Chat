<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Translate Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar for better UX */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>
<body class="h-screen overflow-hidden bg-gray-50">
  <!-- Mobile Header -->
  <div id="mobile-header" class="hidden md:hidden fixed top-0 left-0 right-0 h-14 bg-blue-600 text-white items-center px-4 z-50 shadow-md">
    <button id="menuToggle" class="min-w-[44px] min-h-[44px] flex items-center justify-center text-3xl -ml-2" aria-label="Toggle menu">
      ‚ò∞
    </button>
    <span class="text-lg font-semibold">Translate Chat</span>
  </div>

  <!-- Sidebar Overlay -->
  <div id="sidebar-overlay" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-40 opacity-0 pointer-events-none transition-opacity duration-300"></div>

  <div class="flex h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="w-72 md:w-72 bg-gray-100 border-r border-gray-300 flex flex-col gap-5 p-5 overflow-y-auto custom-scrollbar
                             md:static fixed top-0 left-0 h-full z-50 -translate-x-full md:translate-x-0 transition-transform duration-300 shadow-lg md:shadow-none">
      <h1 class="text-xl font-bold text-gray-800 mb-2">Translate Chat</h1>

      <!-- Active Users Section -->
      <div class="flex flex-col gap-2">
        <h2 class="text-sm font-semibold text-gray-600">
          Active Users (<span id="userCount">0</span>)
        </h2>
        <div id="usersList" class="flex flex-col gap-1 max-h-40 overflow-y-auto custom-scrollbar"></div>
      </div>

      <!-- Name Section -->
      <div class="flex flex-col gap-2">
        <h2 class="text-sm font-semibold text-gray-600">Your Name</h2>
        <div class="flex gap-2">
          <input
            id="nameInput"
            type="text"
            placeholder="Enter your name"
            class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[44px]"
          />
          <button
            id="setNameBtn"
            class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors min-h-[44px] min-w-[60px]"
          >
            Set
          </button>
        </div>
      </div>

      <!-- Languages Section -->
      <div class="flex flex-col gap-2">
        <h2 class="text-sm font-semibold text-gray-600">Chat Languages</h2>
        <div class="flex gap-2">
          <input
            id="langInput"
            type="text"
            placeholder="e.g., fr, spanish"
            class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[44px]"
          />
          <button
            id="addLangBtn"
            class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors min-h-[44px] min-w-[60px]"
          >
            Add
          </button>
        </div>
        <div id="languageList" class="flex flex-col gap-2 max-h-48 overflow-y-auto custom-scrollbar"></div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col md:pt-0 pt-14">
      <!-- Messages Container -->
      <div id="messagesContainer" class="flex-1 overflow-y-auto p-5 bg-white custom-scrollbar"></div>

      <!-- Input Area -->
      <div class="p-4 bg-gray-100 border-t border-gray-300">
        <form id="messageForm" class="flex gap-2">
          <input
            id="messageInput"
            type="text"
            placeholder="Type a message..."
            autocomplete="off"
            class="flex-1 px-4 py-3 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-green-500 min-h-[48px]"
          />
          <button
            type="submit"
            class="px-6 py-3 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 transition-colors min-h-[48px]"
          >
            Send
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Backend URL - automatically detects protocol and host
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsHost = window.location.host;
    const WS_URL = `${wsProtocol}//${wsHost}/ws`;

    // DOM elements
    const messagesContainer = document.getElementById('messagesContainer');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const nameInput = document.getElementById('nameInput');
    const setNameBtn = document.getElementById('setNameBtn');
    const langInput = document.getElementById('langInput');
    const addLangBtn = document.getElementById('addLangBtn');
    const languageList = document.getElementById('languageList');

    // State
    let globalLanguages = [];
    let activeUsers = [];
    let isSending = false;
    let hiddenLanguages = new Set(JSON.parse(localStorage.getItem('hiddenLanguages') || '[]'));

    // WebSocket connection
    const ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      addInfoMsg("Connected! Set your name and add languages to start chatting.");
    };

    ws.onclose = () => {
      addInfoMsg("Disconnected from server.");
    };

    ws.onerror = () => {
      addErrorMsg("WebSocket connection error.");
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.info) {
          addInfoMsg(data.info);
        } else if (data.error) {
          addErrorMsg(data.error);
        } else if (data.type === "language_update") {
          globalLanguages = data.languages || [];
          updateLanguageList();
        } else if (data.type === "users_update") {
          activeUsers = data.users || [];
          updateUsersList();
        } else if (data.type === "chat") {
          addChatMessage(data);
        }
      } catch (err) {
        console.error("Error parsing message:", err);
      }
    };

    // Set name
    setNameBtn.onclick = () => {
      const name = nameInput.value.trim();
      if (!name) return;
      ws.send('/name ' + name);
      nameInput.value = '';
    };

    // Add language
    addLangBtn.onclick = () => {
      const lang = langInput.value.trim();
      if (!lang) return;
      ws.send('/add-lang ' + lang);
      langInput.value = '';
    };

    // Send message
    messageForm.onsubmit = (e) => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text || isSending) return;

      isSending = true;
      const sendBtn = messageForm.querySelector('button[type="submit"]');
      sendBtn.textContent = 'Sending...';
      sendBtn.disabled = true;

      ws.send(text);
      messageInput.value = '';
    };

    // Update language list display
    function updateLanguageList() {
      languageList.innerHTML = '';
      globalLanguages.forEach(lang => {
        const item = document.createElement('div');
        const isHidden = hiddenLanguages.has(lang);
        item.className = 'flex justify-between items-center px-3 py-2 bg-white border border-gray-300 rounded-md text-sm';
        item.innerHTML = `
          <span class="font-medium text-gray-800">${lang.toUpperCase()}</span>
          <div class="flex gap-1">
            <button
              onclick="toggleHideLang('${lang}')"
              class="px-3 py-2 ${isHidden ? 'bg-gray-500' : 'bg-yellow-500'} text-white rounded text-sm hover:opacity-90 transition-opacity min-h-[44px] min-w-[44px] flex items-center justify-center"
              aria-label="${isHidden ? 'Show' : 'Hide'} ${lang}"
            >
              ${isHidden ? 'üëÅÔ∏è' : 'üôà'}
            </button>
            <button
              onclick="removeLang('${lang}')"
              class="px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition-colors min-h-[44px] min-w-[44px] flex items-center justify-center text-lg"
              aria-label="Remove ${lang}"
            >
              √ó
            </button>
          </div>
        `;
        languageList.appendChild(item);
      });
    }

    // Update users list display
    function updateUsersList() {
      const usersList = document.getElementById('usersList');
      const userCount = document.getElementById('userCount');
      usersList.innerHTML = '';
      userCount.textContent = activeUsers.length;

      activeUsers.forEach(user => {
        const item = document.createElement('div');
        item.className = 'px-3 py-2 rounded-md text-sm font-medium truncate';
        item.style.backgroundColor = user.color;
        item.textContent = user.username;
        item.title = user.username; // Show full name on hover
        usersList.appendChild(item);
      });
    }

    // Remove language
    function removeLang(lang) {
      ws.send('/remove-lang ' + lang);
    }

    // Toggle hide/show language
    function toggleHideLang(lang) {
      if (hiddenLanguages.has(lang)) {
        hiddenLanguages.delete(lang);
      } else {
        hiddenLanguages.add(lang);
      }
      localStorage.setItem('hiddenLanguages', JSON.stringify([...hiddenLanguages]));
      updateLanguageList();
    }

    // Add info message
    function addInfoMsg(text) {
      const div = document.createElement('div');
      div.className = 'px-4 py-3 bg-blue-50 text-blue-800 border border-blue-200 rounded-md text-sm mb-2';
      div.textContent = text;
      messagesContainer.appendChild(div);
      scrollToBottom();
    }

    // Add error message
    function addErrorMsg(text) {
      const div = document.createElement('div');
      div.className = 'px-4 py-3 bg-red-50 text-red-800 border border-red-200 rounded-md text-sm mb-2';
      div.textContent = text;
      messagesContainer.appendChild(div);
      scrollToBottom();
    }

    // Add chat message with translations
    function addChatMessage(data) {
      // Reset sending state
      isSending = false;
      const sendBtn = messageForm.querySelector('button[type="submit"]');
      sendBtn.textContent = 'Send';
      sendBtn.disabled = false;

      const div = document.createElement('div');
      div.className = 'mb-4 max-w-[85%] md:max-w-[80%]';

      const header = document.createElement('div');
      header.className = 'inline-block px-3 py-1 rounded-md mb-2 font-semibold text-sm';
      header.style.backgroundColor = data.color || '#e0e0e0';

      // Add sender name and timestamp
      let headerText = data.sender;
      if (data.timestamp) {
        const time = new Date(data.timestamp).toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit'
        });
        headerText += ` ‚Ä¢ ${time}`;
      }
      header.textContent = headerText;
      div.appendChild(header);

      const original = document.createElement('div');
      original.className = 'text-base text-gray-800 mb-2 break-words';
      original.textContent = data.original;
      div.appendChild(original);

      if (data.translations && Object.keys(data.translations).length > 0) {
        const translationsDiv = document.createElement('div');
        translationsDiv.className = 'flex flex-col gap-1 pl-4 border-l-4 border-gray-200';

        for (const [lang, text] of Object.entries(data.translations)) {
          // Skip hidden languages
          if (hiddenLanguages.has(lang.toLowerCase())) continue;

          const transItem = document.createElement('div');
          transItem.className = 'text-sm text-gray-600 break-words';
          transItem.innerHTML = `<span class="font-semibold text-blue-600 mr-2">[${lang}]</span>${text}`;
          translationsDiv.appendChild(transItem);
        }

        div.appendChild(translationsDiv);
      }

      messagesContainer.appendChild(div);
      scrollToBottom();
    }

    // Scroll to bottom
    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Mobile menu functionality
    let sidebarOpen = false;
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const mobileHeader = document.getElementById('mobile-header');

    function initMobileMenu() {
      if (window.innerWidth < 768) {
        mobileHeader.classList.remove('hidden');
        mobileHeader.classList.add('flex');
        overlay.classList.remove('hidden');
      } else {
        mobileHeader.classList.add('hidden');
        mobileHeader.classList.remove('flex');
        overlay.classList.add('hidden');
        closeSidebar();
      }
    }

    function toggleSidebar() {
      sidebarOpen = !sidebarOpen;
      if (sidebarOpen) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        overlay.classList.add('opacity-100', 'pointer-events-auto');
        document.body.style.overflow = 'hidden';
      } else {
        closeSidebar();
      }
    }

    function closeSidebar() {
      sidebarOpen = false;
      sidebar.classList.add('-translate-x-full');
      overlay.classList.remove('opacity-100', 'pointer-events-auto');
      overlay.classList.add('opacity-0', 'pointer-events-none');
      document.body.style.overflow = '';
    }

    // Event listeners
    document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);

    // Initialize on load
    initMobileMenu();

    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(initMobileMenu, 250);
    });
  </script>
</body>
</html>
